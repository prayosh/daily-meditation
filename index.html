
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditation Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Roboto+Mono:wght@300;400&display=swap" rel="stylesheet">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a2e"/>
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --theme-color: #8e44ad;
            --theme-color-dark: #7d3c98;
            --bg-color: #1a1a2e;
            --card-bg-color: #2c2c54;
            --text-color: #f0f0f0;
            --text-color-secondary: #bdc3c7;
            --success-color: #2ecc71;
            --danger-color: #e74c3c;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent scrolling when overlays are open */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 1rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #app-container {
            width: 100%;
            max-width: 900px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 1rem; /* Reduced for compact view */
            overflow-y: auto;
            padding-bottom: 80px; /* Space for FAB */
        }

        /* Scrollbar styling */
        #app-container::-webkit-scrollbar,
        #history-content::-webkit-scrollbar {
            width: 8px;
        }

        #app-container::-webkit-scrollbar-track,
        #history-content::-webkit-scrollbar-track {
            background: var(--card-bg-color);
        }

        #app-container::-webkit-scrollbar-thumb,
        #history-content::-webkit-scrollbar-thumb {
            background-color: var(--theme-color);
            border-radius: 10px;
            border: 2px solid var(--card-bg-color);
        }

        header {
            text-align: center;
        }

        #meditation-emoji {
            font-size: 4rem;
            text-align: center;
            margin-bottom: -1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        header h1 {
            font-size: 2.5rem; /* Reduced for compact view */
            font-weight: 700;
            color: var(--theme-color);
            transition: color 0.3s ease;
        }

        header p {
            color: var(--text-color-secondary);
            font-size: 1.1rem;
        }
        
        #current-date-display {
            color: var(--text-color);
            transition: color 0.3s ease;
        }

        #date-picker {
            margin-top: 0.5rem; /* Reduced for compact view */
            padding: 0.5rem 1rem;
            background-color: var(--card-bg-color);
            border: 1px solid var(--theme-color);
            color: var(--text-color);
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            cursor: pointer;
        }
        #date-picker::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem; /* Reduced for compact view */
        }

        .card {
            background: var(--card-bg-color);
            padding: 1.25rem; /* Reduced for compact view */
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            text-align: center;
            transition: background-color 0.3s ease;
        }

        .card label {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .quick-select-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem; /* Reduced for compact view */
        }
        
        .btn-quick-select {
            padding: 0.4rem 0.2rem;
            font-size: 0.8rem;
            text-align: center;
            background-color: transparent;
            border: 1px solid var(--theme-color);
            color: var(--theme-color);
        }
        
        .btn-quick-select:hover {
            background-color: var(--theme-color) !important;
            color: white !important;
        }

        .card input[type="number"] {
            background: var(--bg-color);
            border: 1px solid var(--theme-color-dark);
            color: var(--text-color);
            padding: 0.75rem;
            border-radius: var(--border-radius);
            font-size: 2rem;
            text-align: center;
            width: 100%;
            -moz-appearance: textfield;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card input::-webkit-outer-spin-button,
        .card input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            background: var(--theme-color);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            text-transform: uppercase;
        }

        .btn:hover {
            background: var(--theme-color-dark);
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background-color: transparent;
            border: 2px solid var(--theme-color);
            color: var(--theme-color);
        }
        .btn-secondary:hover {
            background-color: var(--theme-color);
            color: white;
        }

        .btn-danger {
             background-color: var(--danger-color);
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }

        .total-display {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 0.5rem; /* Reduced for compact view */
        }

        #total-minutes {
            color: var(--theme-color);
            transition: color 0.3s ease;
        }

        #emoji-indicator {
            grid-column: 1 / -1;
            font-size: 3.5rem; /* Reduced for compact view */
            text-align: center;
            margin-top: 0.5rem; /* Reduced for compact view */
        }

        #menu-toggle-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--theme-color);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            z-index: 1001;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }
        #menu-toggle-btn:hover {
            transform: scale(1.1) rotate(15deg);
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .overlay.active {
            opacity: 1;
            visibility: visible;
        }

        #side-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            height: 100%;
            background: var(--card-bg-color);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease, background-color 0.3s ease;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-y: auto;
        }

        #side-menu.open {
            transform: translateX(0);
        }
        #side-menu h2 {
            margin-bottom: 1rem;
            color: var(--theme-color);
            transition: color 0.3s ease;
        }

        .menu-section {
            border-top: 1px solid var(--theme-color-dark);
            padding-top: 1rem;
        }
        .menu-section .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        .menu-section label {
             display: block;
             margin-bottom: 0.5rem;
        }
        
        .theme-control-group {
            margin-bottom: 1rem;
        }
        .theme-control-group label {
            display: block;
            margin-bottom: 0.5rem;
        }
        .theme-inputs {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .theme-inputs input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            background-color: transparent;
            border: 2px solid var(--theme-color-dark);
            border-radius: 8px;
            cursor: pointer;
            padding: 2px;
        }
        .theme-inputs input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        .theme-inputs input[type="color"]::-webkit-color-swatch {
            border-radius: 4px;
            border: none;
        }
        .theme-inputs input[type="color"]::-moz-color-swatch {
            border-radius: 4px;
            border: none;
        }

        .theme-inputs input[type="text"] {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--theme-color-dark);
            background: var(--bg-color);
            color: var(--text-color);
        }

        .theme-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--bg-color);
            border: 1px solid var(--theme-color-dark);
            border-radius: 5px;
            outline: none;
            padding: 0;
            margin-top: 0.5rem;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--theme-color);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--card-bg-color);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--theme-color);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--card-bg-color);
        }

        .full-overlay {
            z-index: 1002;
            background: var(--bg-color);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transform: scale(0.95);
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease, background-color 0.3s ease;
        }

        .full-overlay.active {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
        }
        
        .full-overlay-header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .full-overlay-header h2 {
            font-size: 2rem;
            color: var(--theme-color);
        }

        #history-content {
            width: 100%;
            max-width: 1200px;
            flex-grow: 1;
            overflow-y: auto;
        }

        #history-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        #history-table th, #history-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--theme-color-dark);
        }
        #history-table th {
            position: sticky;
            top: 0;
            background-color: var(--bg-color);
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        #history-table tbody tr:hover {
            background-color: var(--card-bg-color);
        }
        #history-table .total-col {
            background-color: rgba(241, 196, 15, 0.1);
            color: #f1c40f;
            font-weight: 700;
        }

        .modal-overlay {
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1003; /* Ensure it's above other overlays */
        }

        .modal-content {
            background: var(--card-bg-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        .overlay.active .modal-content {
            transform: scale(1);
        }
        .modal-content h2 {
            margin-bottom: 1.5rem;
            color: var(--theme-color);
            transition: color 0.3s ease;
        }

        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: bottom 0.5s ease;
            z-index: 2000;
            font-weight: 600;
        }
        #toast.show {
            bottom: 2rem;
        }

        /* Timer and Stopwatch Styles */
        .timer-stopwatch-container {
            width: 100%;
            max-width: 500px;
            margin: 2rem auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .tab-nav {
            display: flex;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            border: 1px solid var(--theme-color-dark);
            transition: background-color 0.3s ease;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            background-color: transparent;
            color: var(--text-color-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .tab-btn.active {
            background-color: var(--theme-color);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .tab-content.active {
            display: flex;
        }

        .large-display {
            font-size: 5rem;
            font-weight: 300;
            letter-spacing: 4px;
            font-family: 'Roboto Mono', monospace;
            color: #FFFFFF;
            transition: color 0.3s ease;
        }

        .timer-presets {
            display: flex;
            gap: 1rem;
            width: 100%;
            align-items: center;
        }

        .themed-select {
            flex-grow: 1;
            padding: 0.75rem;
            background-color: var(--card-bg-color);
            border: 1px solid var(--theme-color-dark);
            color: var(--text-color);
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }
        
        .timer-controls, .stopwatch-actions {
            display: grid;
            width: 100%;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }
        
        .stopwatch-controls {
            display: flex;
            justify-content: center;
            width: 100%;
            gap: 1rem;
        }

        .stopwatch-controls .btn {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            flex: 1;
            max-width: 120px;
        }

        .stopwatch-actions-label {
            color: var(--text-color-secondary);
            margin-top: 1rem;
            font-size: 0.9rem;
            text-align: center;
            width: 100%;
        }

        #preset-list-container {
            width: 100%;
            text-align: left;
        }

        .preset-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--theme-color-dark);
        }
        .preset-item:last-child {
            border-bottom: none;
        }

        .preset-item-actions button {
            background: none;
            border: none;
            color: var(--text-color-secondary);
            cursor: pointer;
            margin-left: 0.5rem;
            font-size: 1rem;
        }
        .preset-item-actions button:hover {
            color: var(--theme-color);
        }

        #preset-form input[type="number"] {
            padding: 0.5rem;
            background-color: var(--bg-color);
            border: 1px solid var(--theme-color-dark);
            color: var(--text-color);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
        }
        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border-width: 0;
        }

        @media (max-width: 768px) {
            body { padding: 0.5rem; }
            #app-container { gap: 1rem; padding-bottom: 70px; }
            header h1 { font-size: 2rem; }
            header p { font-size: 1rem; }
            main { grid-template-columns: 1fr; gap: 1rem; }
            .card { padding: 1.5rem; }
            #menu-toggle-btn { bottom: 1rem; right: 1rem; width: 50px; height: 50px; }
            .full-overlay { padding: 1rem; }
            .full-overlay-header h2 { font-size: 1.5rem; }
            #history-table th, #history-table td { padding: 0.5rem; font-size: 0.9rem; }
            .large-display { font-size: 4rem; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <header>
            <div id="meditation-emoji">üßò‚Äç‚ôÄÔ∏è</div>
            <h1>Daily Meditation</h1>
            <p id="current-date-display">22/10/2025 ‚Äî Wednesday</p>
            <input type="date" id="date-picker">
        </header>

        <main>
            <section class="card">
                <label for="morning-duration">Morning Duration (minutes)</label>
                <div class="quick-select-buttons">
                    <button class="btn btn-quick-select" data-value="5">5</button>
                    <button class="btn btn-quick-select" data-value="10">10</button>
                    <button class="btn btn-quick-select" data-value="15">15</button>
                    <button class="btn btn-quick-select" data-value="20">20</button>
                    <button class="btn btn-quick-select" data-value="25">25</button>
                    <button class="btn btn-quick-select" data-value="30">30</button>
                </div>
                <input type="number" id="morning-duration" min="0" placeholder="0">
                <button class="btn" id="save-morning">Save Morning</button>
            </section>
            <section class="card">
                <label for="evening-duration">Evening Duration (minutes)</label>
                 <div class="quick-select-buttons">
                    <button class="btn btn-quick-select" data-value="5">5</button>
                    <button class="btn btn-quick-select" data-value="10">10</button>
                    <button class="btn btn-quick-select" data-value="15">15</button>
                    <button class="btn btn-quick-select" data-value="20">20</button>
                    <button class="btn btn-quick-select" data-value="25">25</button>
                    <button class="btn btn-quick-select" data-value="30">30</button>
                </div>
                <input type="number" id="evening-duration" min="0" placeholder="0">
                <button class="btn" id="save-evening">Save Evening</button>
            </section>
            <div class="total-display">
                Total for this day: <span id="total-minutes">0</span>
            </div>
            <div id="emoji-indicator">‚òπÔ∏è</div>
        </main>
    </div>

    <!-- Floating Menu Button -->
    <button id="menu-toggle-btn" aria-label="Open Menu">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    
    <!-- Side Menu -->
    <div id="menu-overlay" class="overlay"></div>
    <nav id="side-menu">
        <h2>Menu</h2>
        <div class="menu-section">
            <button class="btn" id="menu-history">History</button>
        </div>
        <div class="menu-section">
            <label>Export / Import</label>
            <button class="btn" id="export-json">Export JSON</button>
            <button class="btn" id="import-json-btn">Import JSON</button>
            <input type="file" id="import-json-input" accept=".json" hidden>
            <button class="btn" id="export-csv">Export Excel (CSV)</button>
        </div>
        <div class="menu-section">
            <button class="btn" id="menu-stopwatch">Timer & Stopwatch</button>
        </div>
        <div class="menu-section">
            <h2>Customize Theme</h2>
            <div class="theme-control-group">
                <label for="theme-color-input">Primary Color</label>
                <div class="theme-inputs">
                    <input type="color" id="theme-color-picker">
                    <input type="text" id="theme-color-input">
                </div>
            </div>
             <div class="theme-control-group">
                <label for="bg-color-input">Background Color</label>
                <div class="theme-inputs">
                    <input type="color" id="bg-color-picker">
                    <input type="text" id="bg-color-input">
                </div>
            </div>
             <div class="theme-control-group">
                <label for="card-bg-color-input">Card Color</label>
                <div class="theme-inputs">
                    <input type="color" id="card-bg-color-picker">
                    <input type="text" id="card-bg-color-input">
                </div>
            </div>
            <div class="theme-control-group">
                <label for="text-color-input">Text Color</label>
                <div class="theme-inputs">
                    <input type="color" id="text-color-picker">
                    <input type="text" id="text-color-input">
                </div>
            </div>
             <div class="theme-control-group">
                <label for="global-size-slider">Interface Size</label>
                <input type="range" id="global-size-slider" min="0.8" max="1.3" step="0.05" value="0.8">
            </div>
            <div class="theme-buttons">
                <button class="btn" id="apply-theme">Apply</button>
                <button class="btn btn-secondary" id="reset-theme">Reset</button>
            </div>
        </div>
         <div class="menu-section">
             <label>Danger Zone</label>
             <button class="btn btn-danger" id="delete-data-btn">Delete All Data</button>
        </div>
    </nav>

    <!-- History Overlay -->
    <div id="history-overlay" class="overlay full-overlay">
        <div class="full-overlay-header">
            <h2>History</h2>
            <div style="display: flex; gap: 1rem;">
                <button class="btn" id="download-csv-history">Download CSV</button>
                <button class="btn btn-secondary" id="close-history">Home</button>
            </div>
        </div>
        <div id="history-content">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>S.No</th>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Morning (min)</th>
                        <th>Evening (min)</th>
                        <th class="total-col">Total (min)</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <!-- Timer & Stopwatch Overlay -->
    <div id="timer-stopwatch-overlay" class="overlay full-overlay">
        <div class="full-overlay-header">
            <h2>Timer & Stopwatch</h2>
            <button class="btn btn-secondary" id="close-timer-stopwatch">Home</button>
        </div>
        <div class="timer-stopwatch-container">
            <div class="tab-nav">
                <button class="tab-btn active" data-tab="timer">Timer</button>
                <button class="tab-btn" data-tab="stopwatch">Stopwatch</button>
            </div>
            <!-- Timer Content -->
            <div id="timer-content" class="tab-content active">
                <div id="timer-display" class="large-display">05:00</div>
                <div class="timer-presets">
                    <label for="timer-preset-select" class="sr-only">Select Timer Preset</label>
                    <select id="timer-preset-select" class="themed-select"></select>
                    <button id="manage-presets-btn" class="btn btn-secondary">Manage</button>
                </div>
                <div class="timer-controls">
                    <button class="btn" id="timer-start-pause">Start</button>
                    <button class="btn btn-danger" id="timer-reset">Reset</button>
                </div>
            </div>
            <!-- Stopwatch Content -->
            <div id="stopwatch-content" class="tab-content">
                <div id="stopwatch-display" class="large-display">00:00:00</div>
                <div class="stopwatch-controls">
                    <button class="btn" id="stopwatch-start">Start</button>
                    <button class="btn" id="stopwatch-pause">Pause</button>
                    <button class="btn" id="stopwatch-reset">Reset</button>
                </div>
                <p class="stopwatch-actions-label">When done, add time to today's session:</p>
                <div class="stopwatch-actions">
                    <button class="btn" id="stopwatch-add-morning">Add to Morning</button>
                    <button class="btn" id="stopwatch-add-evening">Add to Evening</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preset Management Modal -->
    <div id="preset-modal-overlay" class="overlay modal-overlay">
        <div class="modal-content">
            <h2>Manage Presets</h2>
            <div id="preset-list-container" style="max-height: 200px; overflow-y: auto; margin-bottom: 1.5rem;">
                <!-- Presets will be rendered here -->
            </div>
            <form id="preset-form" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" id="preset-id">
                <div style="display: flex; gap: 1rem;">
                    <div style="flex: 1;">
                        <label for="preset-minutes" style="display: block; text-align: left; margin-bottom: 0.5rem;">Minutes</label>
                        <input type="number" id="preset-minutes" min="0" max="90" value="5" required style="width: 100%;">
                    </div>
                    <div style="flex: 1;">
                        <label for="preset-seconds" style="display: block; text-align: left; margin-bottom: 0.5rem;">Seconds</label>
                        <input type="number" id="preset-seconds" min="0" max="59" value="0" required style="width: 100%;">
                    </div>
                </div>
                <div class="modal-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <button type="submit" class="btn">Save Preset</button>
                    <button type="button" class="btn btn-secondary" id="preset-cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CSV Date Range Modal -->
    <div id="csv-modal-overlay" class="overlay modal-overlay">
        <div class="modal-content">
            <h2>Export Date Range</h2>
            <div class="date-range-inputs" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <label for="csv-start-date" style="display: block; margin-bottom: 0.5rem; text-align: left;">Start Date</label>
                    <input type="date" id="csv-start-date" style="width: 100%; padding: 0.5rem; background-color: var(--bg-color); border: 1px solid var(--theme-color-dark); color: var(--text-color); border-radius: 8px; font-family: 'Poppins', sans-serif;">
                </div>
                <div>
                    <label for="csv-end-date" style="display: block; margin-bottom: 0.5rem; text-align: left;">End Date</label>
                    <input type="date" id="csv-end-date" style="width: 100%; padding: 0.5rem; background-color: var(--bg-color); border: 1px solid var(--theme-color-dark); color: var(--text-color); border-radius: 8px; font-family: 'Poppins', sans-serif;">
                </div>
            </div>
            <div class="modal-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button class="btn" id="csv-confirm-export">Export</button>
                <button class="btn btn-secondary" id="csv-cancel-export">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Weekly Reminder Modal -->
    <div id="reminder-modal-overlay" class="overlay modal-overlay">
        <div class="modal-content">
            <h2>Weekly Reminder</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-color-secondary);">It's Sunday! A great time to back up your meditation history.</p>
            <div class="modal-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button class="btn" id="reminder-export-btn">Export Now</button>
                <button class="btn btn-secondary" id="reminder-later-btn">Maybe Later</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal-overlay" class="overlay modal-overlay">
        <div class="modal-content">
            <h2>Are you sure?</h2>
            <p style="margin-bottom: 1.5rem; color: var(--text-color-secondary);">This action will permanently delete all your meditation history. This cannot be undone.</p>
            <div class="modal-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <button class="btn btn-danger" id="delete-confirm-btn">Confirm Delete</button>
                <button class="btn btn-secondary" id="delete-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Alarm Sound -->
    <audio id="alarm-sound" src="data:audio/mpeg;base64,SUQzBAAAAAAAI1RDT04AAAAGAAAAMikNVUkAAAAsAAAAY2h0dHA6Ly93d3cuZ3JzaXRlLmNvbS9zb3VuZC9tdXNpYy5odG0AAE9VUkMAAAAUAAAAaHR0cDovL3d3dy5ncnNpdGUuY29tAABUQUxCAAAAFgAAAGh0dHA6Ly93d3cuZ3JzaXRlLmNvbQAAVFNTRQAAAAgAAABMYXZmNTIuNQAAAP//uQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQwgAYE////+uB7hT//g4P/w8//w8P/yP/xP/4P/v//lP/hP/lP/xP+P+P/v//78P/78P/w8P/w8P/v7//+//7//7//lP+P+P/7//7//v//v8P/78P/xP/xP/BP/7P//v//v//v/+P/xP/xP+P/7//7//v//7//v//v//7//v//v//v//v//v//v//v//v//v//v//7//v//v//v//v//v//v//v//v//v//v//v//uQwfZ4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEU291bmQgRm9yZ2UgNC41AP/7kMQYGBL/wD/4D/8AD/4D/8D/wP/A/+D/4P/g/+D/gP+A/4D/wP/A/4D/wP/A/4D/wP/A/+D/gP+A/4D/wP/A/+D/4D/wP/A/8D/wP/A/4D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/4D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8D/wP/A/8-BwgAEAcIAA8HCAAOBwgADAcIAAoHCAAHBwgABgcIAAoHCgAMBwsADgcMAA8HDQAQBw4AEwcPABQHEgAXBxMAHAcVABwHGAAeBxsAIAcdACIHIAAjByMAJwcmACkHKwAsBywALgcwADEHMwA0BzkAOAoAADYKBAA5CgYAPQoIABAKCgAQAwsAEwMMABQDDgAWAxAAGQMSABwDFQAdAxYAHwMYACIDGgAkAxwAJgMeACgDJAApAyU="></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            'use strict';

            // --- DOM ELEMENTS ---
            const datePicker = document.getElementById('date-picker');
            const currentDateDisplay = document.getElementById('current-date-display');
            const morningInput = document.getElementById('morning-duration');
            const eveningInput = document.getElementById('evening-duration');
            const totalMinutesDisplay = document.getElementById('total-minutes');
            const emojiIndicator = document.getElementById('emoji-indicator');
            const saveMorningBtn = document.getElementById('save-morning');
            const saveEveningBtn = document.getElementById('save-evening');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const menuOverlay = document.getElementById('menu-overlay');
            const sideMenu = document.getElementById('side-menu');
            const historyBtn = document.getElementById('menu-history');
            const historyOverlay = document.getElementById('history-overlay');
            const closeHistoryBtn = document.getElementById('close-history');
            const historyTableBody = document.querySelector('#history-table tbody');
            const exportJsonBtn = document.getElementById('export-json');
            const importJsonBtn = document.getElementById('import-json-btn');
            const importJsonInput = document.getElementById('import-json-input');
            const exportCsvBtn = document.getElementById('export-csv');
            const downloadCsvHistoryBtn = document.getElementById('download-csv-history');
            const stopwatchBtn = document.getElementById('menu-stopwatch');
            const stopwatchDisplay = document.getElementById('stopwatch-display');
            const stopwatchStartBtn = document.getElementById('stopwatch-start');
            const stopwatchPauseBtn = document.getElementById('stopwatch-pause');
            const stopwatchResetBtn = document.getElementById('stopwatch-reset');
            const stopwatchAddMorningBtn = document.getElementById('stopwatch-add-morning');
            const stopwatchAddEveningBtn = document.getElementById('stopwatch-add-evening');
            const toast = document.getElementById('toast');
            
            const csvModalOverlay = document.getElementById('csv-modal-overlay');
            const csvStartDate = document.getElementById('csv-start-date');
            const csvEndDate = document.getElementById('csv-end-date');
            const csvConfirmExportBtn = document.getElementById('csv-confirm-export');
            const csvCancelExportBtn = document.getElementById('csv-cancel-export');
            const reminderModalOverlay = document.getElementById('reminder-modal-overlay');
            const reminderExportBtn = document.getElementById('reminder-export-btn');
            const reminderLaterBtn = document.getElementById('reminder-later-btn');

            // Theme Elements
            const themeColorInput = document.getElementById('theme-color-input');
            const themeColorPicker = document.getElementById('theme-color-picker');
            const bgColorInput = document.getElementById('bg-color-input');
            const bgColorPicker = document.getElementById('bg-color-picker');
            const cardBgColorInput = document.getElementById('card-bg-color-input');
            const cardBgColorPicker = document.getElementById('card-bg-color-picker');
            const textColorInput = document.getElementById('text-color-input');
            const textColorPicker = document.getElementById('text-color-picker');
            const applyThemeBtn = document.getElementById('apply-theme');
            const resetThemeBtn = document.getElementById('reset-theme');
            const globalSizeSlider = document.getElementById('global-size-slider');

            // Delete Data Elements
            const deleteDataBtn = document.getElementById('delete-data-btn');
            const deleteModalOverlay = document.getElementById('delete-modal-overlay');
            const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
            const deleteCancelBtn = document.getElementById('delete-cancel-btn');

            // Timer & Stopwatch elements
            const timerStopwatchOverlay = document.getElementById('timer-stopwatch-overlay');
            const closeTimerStopwatchBtn = document.getElementById('close-timer-stopwatch');
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const timerDisplay = document.getElementById('timer-display');
            const timerPresetSelect = document.getElementById('timer-preset-select');
            const managePresetsBtn = document.getElementById('manage-presets-btn');
            const timerStartPauseBtn = document.getElementById('timer-start-pause');
            const timerResetBtn = document.getElementById('timer-reset');
            const alarmSound = document.getElementById('alarm-sound');

            // Preset Management Modal elements
            const presetModalOverlay = document.getElementById('preset-modal-overlay');
            const presetListContainer = document.getElementById('preset-list-container');
            const presetForm = document.getElementById('preset-form');
            const presetIdInput = document.getElementById('preset-id');
            const presetMinutesInput = document.getElementById('preset-minutes');
            const presetSecondsInput = document.getElementById('preset-seconds');
            const presetCancelBtn = document.getElementById('preset-cancel-btn');

            // --- STATE & CONSTANTS ---
            const STORAGE_KEY = 'meditation_tracking_v1';
            const THEME_SETTINGS_KEY = 'meditation_theme_settings_v1';
            const FONT_SIZE_KEY = 'meditation_font_size_v1';
            const DEFAULT_THEME_SETTINGS = {
                '--theme-color': '#8e44ad',
                '--bg-color': '#1a1a2e',
                '--card-bg-color': '#2c2c54',
                '--text-color': '#f0f0f0',
            };
            let data = [];
            let stopwatchInterval = null;
            let stopwatchState = { elapsed: 0, startTime: 0, isRunning: false };
            let audioContextUnlocked = false;

            // --- DATA FUNCTIONS ---
            const loadDataFromStorage = () => {
                const storedData = localStorage.getItem(STORAGE_KEY);
                data = storedData ? JSON.parse(storedData) : [];
            };

            const saveDataToStorage = () => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            };

            const getRecordForDate = (isoDate) => {
                return data.find(record => record.date === isoDate);
            };

            const addOrUpdateRecord = (isoDate, session, minutes) => {
                let record = getRecordForDate(isoDate);
                if (record) {
                    record[session] = minutes;
                } else {
                    const newRecord = { date: isoDate, morning: 0, evening: 0 };
                    newRecord[session] = minutes;
                    data.push(newRecord);
                }
                saveDataToStorage();
                updateUIForDate(isoDate);
            };

            const backfillMissingDays = () => {
                if (data.length === 0) return;

                const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
                const lastRecordDate = new Date(sortedData[0].date + 'T00:00:00');
                
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                yesterday.setHours(0, 0, 0, 0);

                if (lastRecordDate >= yesterday) return;

                let currentDate = new Date(lastRecordDate);
                currentDate.setDate(currentDate.getDate() + 1);

                let added = false;
                while (currentDate <= yesterday) {
                    const isoDate = currentDate.toISOString().split('T')[0];
                    if (!getRecordForDate(isoDate)) {
                        data.push({ date: isoDate, morning: 0, evening: 0 });
                        added = true;
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                if (added) {
                    saveDataToStorage();
                }
            };

            // --- UI UPDATE FUNCTIONS ---
            const updateHeaderDate = () => {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' };
                const formattedDate = today.toLocaleDateString('en-GB', options).replace(/,/g, ' ‚Äî');
                currentDateDisplay.textContent = formattedDate;
            };

            const updateUIForDate = (isoDate) => {
                const record = getRecordForDate(isoDate);
                const morning = record ? record.morning : 0;
                const evening = record ? record.evening : 0;
                
                morningInput.value = morning > 0 ? morning : '';
                eveningInput.value = evening > 0 ? evening : '';
                
                const total = morning + evening;
                totalMinutesDisplay.textContent = total;

                if (total === 0) {
                    emojiIndicator.textContent = '‚òπÔ∏è';
                } else if (total < 30) {
                    emojiIndicator.textContent = 'üòÉ';
                } else if (total < 60) {
                    emojiIndicator.textContent = 'üòç';
                } else {
                    emojiIndicator.textContent = 'üî•';
                }
            };

            const renderHistoryTable = () => {
                historyTableBody.innerHTML = '';
                const sortedData = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedData.forEach((record, index) => {
                    const tr = document.createElement('tr');
                    const displayDate = new Date(record.date + 'T00:00:00');
                    const day = displayDate.toLocaleDateString('en-US', { weekday: 'short' });
                    const date = displayDate.toLocaleDateString('en-GB');
                    const total = record.morning + record.evening;

                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${date}</td>
                        <td>${day}</td>
                        <td>${record.morning}</td>
                        <td>${record.evening}</td>
                        <td class="total-col">${total}</td>
                    `;
                    historyTableBody.appendChild(tr);
                });
            };
            
            const showToast = (message) => {
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 2000);
            };

            // --- DATE & TIME UTILS ---
            const getTodayISO = () => new Date().toISOString().split('T')[0];
            
            // --- SIZE CONTROL ---
            const applyGlobalSize = (scale) => {
                document.documentElement.style.fontSize = `${scale * 100}%`;
            };

            const saveGlobalSize = (scale) => {
                localStorage.setItem(FONT_SIZE_KEY, scale);
            };

            const loadGlobalSize = () => {
                const savedSize = localStorage.getItem(FONT_SIZE_KEY);
                const scale = savedSize ? parseFloat(savedSize) : 0.8; 
                applyGlobalSize(scale);
                globalSizeSlider.value = scale;
            };

            // --- EVENT HANDLERS ---
            const handleDateChange = (e) => {
                updateUIForDate(e.target.value);
            };
            
            const handleSizeChange = (e) => {
                const scale = e.target.value;
                applyGlobalSize(scale);
                saveGlobalSize(scale);
            };

            const handleSave = (session) => {
                const input = session === 'morning' ? morningInput : eveningInput;
                const minutes = parseInt(input.value, 10) || 0;
                if (minutes < 0) {
                    showToast('Invalid input. Please enter a positive number.');
                    const record = getRecordForDate(datePicker.value);
                    const sessionMinutes = record ? record[session] : 0;
                    input.value = sessionMinutes > 0 ? sessionMinutes : '';
                    return;
                }
                addOrUpdateRecord(datePicker.value, session, minutes);
                showToast(`${session.charAt(0).toUpperCase() + session.slice(1)} session saved!`);
            };
            
            const handleQuickSelect = (e) => {
                const button = e.target.closest('.btn-quick-select');
                if (!button) return;

                const value = button.dataset.value;
                const card = button.closest('.card');
                const input = card.querySelector('input[type="number"]');
                if (input) {
                    input.value = value;
                }
            };

            const toggleMenu = () => {
                sideMenu.classList.toggle('open');
                menuOverlay.classList.toggle('active');
            };

            const openHistory = () => {
                renderHistoryTable();
                historyOverlay.classList.add('active');
                if (sideMenu.classList.contains('open')) toggleMenu();
            };
            const closeHistory = () => historyOverlay.classList.remove('active');

            // --- THEME ---
            const applyTheme = (settings) => {
                const hexColorRegex = /^#([0-9a-f]{3}){1,2}$/i;
                for (const [key, value] of Object.entries(settings)) {
                    if (!hexColorRegex.test(value)) {
                        showToast(`Invalid HEX color format for ${key}.`);
                        return false;
                    }
                    document.documentElement.style.setProperty(key, value);
                }
                
                const themeColor = settings['--theme-color'];
                let r = 0, g = 0, b = 0;
                if (themeColor.length === 4) {
                    r = parseInt(themeColor[1] + themeColor[1], 16);
                    g = parseInt(themeColor[2] + themeColor[2], 16);
                    b = parseInt(themeColor[3] + themeColor[3], 16);
                } else if (themeColor.length === 7) {
                    r = parseInt(themeColor.slice(1, 3), 16);
                    g = parseInt(themeColor.slice(3, 5), 16);
                    b = parseInt(themeColor.slice(5, 7), 16);
                }
                const darkerColor = `rgb(${Math.max(0, r-20)}, ${Math.max(0, g-20)}, ${Math.max(0, b-20)})`;
                document.documentElement.style.setProperty('--theme-color-dark', darkerColor);
                return true;
            };

            const updateThemeInputs = (theme) => {
                themeColorInput.value = theme['--theme-color'];
                themeColorPicker.value = theme['--theme-color'];
                bgColorInput.value = theme['--bg-color'];
                bgColorPicker.value = theme['--bg-color'];
                cardBgColorInput.value = theme['--card-bg-color'];
                cardBgColorPicker.value = theme['--card-bg-color'];
                textColorInput.value = theme['--text-color'];
                textColorPicker.value = theme['--text-color'];
            };
            
            const loadTheme = () => {
                const savedSettings = localStorage.getItem(THEME_SETTINGS_KEY);
                const theme = savedSettings ? JSON.parse(savedSettings) : DEFAULT_THEME_SETTINGS;
                applyTheme(theme);
                updateThemeInputs(theme);
            };

            const handleThemeApply = () => {
                const newSettings = {
                    '--theme-color': themeColorInput.value,
                    '--bg-color': bgColorInput.value,
                    '--card-bg-color': cardBgColorInput.value,
                    '--text-color': textColorInput.value,
                };
                if (applyTheme(newSettings)) {
                    localStorage.setItem(THEME_SETTINGS_KEY, JSON.stringify(newSettings));
                    showToast('Theme applied!');
                }
            };
            
            const handleThemeReset = () => {
                applyTheme(DEFAULT_THEME_SETTINGS);
                updateThemeInputs(DEFAULT_THEME_SETTINGS);
                localStorage.removeItem(THEME_SETTINGS_KEY);
                
                applyGlobalSize(0.8);
                globalSizeSlider.value = 0.8;
                localStorage.removeItem(FONT_SIZE_KEY);

                showToast('Theme reset to default.');
            };

            // --- EXPORT / IMPORT ---
            const generateCSV = (startDate, endDate) => {
                let csvContent = "S.No,Date(dd/mm/yyyy),Day,Morning (min),Evening (min),Total (min)\n";
                let filteredData = [...data];
                if (startDate && endDate) {
                    filteredData = filteredData.filter(record => record.date >= startDate && record.date <= endDate);
                }
                const sortedData = filteredData.sort((a, b) => new Date(a.date) - new Date(b.date));
                sortedData.forEach((record, index) => {
                    const displayDate = new Date(record.date + 'T00:00:00');
                    const day = displayDate.toLocaleDateString('en-US', { weekday: 'short' });
                    const date = displayDate.toLocaleDateString('en-GB');
                    const total = record.morning + record.evening;
                    csvContent += `${index + 1},${date},${day},${record.morning},${record.evening},${total}\n`;
                });
                return csvContent;
            };

            const downloadFile = (content, fileName, contentType) => {
                const a = document.createElement("a");
                const file = new Blob([content], { type: contentType });
                a.href = URL.createObjectURL(file);
                a.download = fileName;
                a.click();
                URL.revokeObjectURL(a.href);
            };

            const handleExportJson = () => {
                downloadFile(JSON.stringify(data, null, 2), 'meditation_data.json', 'application/json');
                showToast('JSON data exported.');
            };

            const openCsvModal = () => {
                if (data.length === 0) {
                    showToast('No data to export.');
                    return;
                }
                const sortedData = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));
                csvStartDate.value = sortedData[0].date;
                csvEndDate.value = sortedData[sortedData.length - 1].date;
                csvModalOverlay.classList.add('active');
            };
            const closeCsvModal = () => csvModalOverlay.classList.remove('active');

            const handleConfirmExport = () => {
                const startDate = csvStartDate.value;
                const endDate = csvEndDate.value;
                if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
                    showToast('Invalid date range.');
                    return;
                }
                const csv = generateCSV(startDate, endDate);
                downloadFile(csv, `meditation_history_${startDate}_to_${endDate}.csv`, 'text/csv;charset=utf-8;');
                showToast('CSV data exported.');
                closeCsvModal();
            };
            
            const handleExportCsv = () => {
                openCsvModal();
            };

            const handleImportJson = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData) && importedData.every(item => 'date' in item && 'morning' in item && 'evening' in item)) {
                            if (confirm('Importing will replace all current data. Continue?')) {
                                data = importedData;
                                saveDataToStorage();
                                updateUIForDate(datePicker.value);
                                showToast('Data imported successfully!');
                            }
                        } else {
                            throw new Error('Invalid data format.');
                        }
                    } catch (error) {
                        alert(`Import failed: ${error.message}`);
                    }
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset input
            };

            // --- STOPWATCH ---
            const formatStopwatchTime = (ms) => {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            };
            const updateStopwatchDisplay = () => {
                const now = Date.now();
                const elapsed = stopwatchState.elapsed + (stopwatchState.isRunning ? now - stopwatchState.startTime : 0);
                stopwatchDisplay.textContent = formatStopwatchTime(elapsed);
            };
            const startStopwatch = () => {
                if (!stopwatchState.isRunning) {
                    stopwatchState.isRunning = true;
                    stopwatchState.startTime = Date.now();
                    stopwatchInterval = setInterval(updateStopwatchDisplay, 1000);
                }
            };
            const pauseStopwatch = () => {
                if (stopwatchState.isRunning) {
                    stopwatchState.isRunning = false;
                    stopwatchState.elapsed += Date.now() - stopwatchState.startTime;
                    clearInterval(stopwatchInterval);
                }
            };
            const resetStopwatch = () => {
                pauseStopwatch();
                stopwatchState.elapsed = 0;
                updateStopwatchDisplay();
            };
            const addStopwatchToSession = (session) => {
                pauseStopwatch();
                const totalMs = stopwatchState.elapsed;
                const totalMinutes = Math.round(totalMs / 1000 / 60);
                if (totalMinutes > 0) {
                    const input = session === 'morning' ? morningInput : eveningInput;
                    const record = getRecordForDate(datePicker.value);
                    const currentMinutes = (record && record[session]) ? parseInt(record[session], 10) : 0;
                    input.value = currentMinutes + totalMinutes;
                    handleSave(session);
                    resetStopwatch();
                    closeTimerStopwatch();
                } else {
                    showToast('Stopwatch time is less than a minute.');
                }
            };

            // --- TIMER & PRESETS ---
            const TIMER_PRESETS_KEY = 'meditation_timer_presets_v1';
            let timerPresets = [];
            let timerState = { remaining: 0, totalDuration: 0, isRunning: false, intervalId: null };

            const unlockAudioContext = () => {
                if (audioContextUnlocked || !alarmSound) return;
                
                const playPromise = alarmSound.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        // If it plays, immediately pause it. We just wanted to unlock.
                        alarmSound.pause();
                        alarmSound.currentTime = 0;
                        audioContextUnlocked = true;
                        console.log('Audio Context unlocked by user interaction.');
                    }).catch(error => {
                        console.warn('Audio unlock attempt failed, but the user gesture should be registered.', error);
                        // Even if it fails, the browser often registers the intent.
                        audioContextUnlocked = true;
                    });
                }
            };

            const formatTimeForDisplay = (totalSeconds) => {
                const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                return `${minutes}:${seconds}`;
            };

            const updateTimerDisplay = () => {
                timerDisplay.textContent = formatTimeForDisplay(timerState.remaining);
            };

            const playAlarm = () => {
                alarmSound.currentTime = 0;
                alarmSound.loop = false; // Ensure alarm plays only once

                const playPromise = alarmSound.play();

                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error("Alarm playback failed:", error);
                        // If autoplay is prevented, provide a fallback for the user.
                        if (error.name === 'NotAllowedError') {
                            showToast('Tap screen to enable alarm sound.');
                            
                            const playOnTap = () => {
                                alarmSound.play().catch(e => console.error("Playback on tap also failed:", e));
                            };
                            document.body.addEventListener('click', playOnTap, { once: true });
                            document.body.addEventListener('touchend', playOnTap, { once: true });
                        }
                    });
                }
            };

            const resetTimer = () => {
                if (timerState.intervalId) {
                    clearInterval(timerState.intervalId);
                    timerState.intervalId = null;
                }
                timerState.isRunning = false;
                timerStartPauseBtn.textContent = 'Start';
                timerState.remaining = timerState.totalDuration;
                updateTimerDisplay();
            };

            const startPauseTimer = () => {
                if (timerState.isRunning) { // Pause
                    clearInterval(timerState.intervalId);
                    timerState.intervalId = null;
                    timerState.isRunning = false;
                    timerStartPauseBtn.textContent = 'Resume';
                } else { // Start/Resume
                    if (timerState.remaining <= 0) return;
                    timerState.isRunning = true;
                    timerStartPauseBtn.textContent = 'Pause';
                    timerState.intervalId = setInterval(() => {
                        timerState.remaining--;
                        updateTimerDisplay();
                        if (timerState.remaining <= 0) {
                            clearInterval(timerState.intervalId);
                            timerState.intervalId = null;
                            timerState.isRunning = false;
                            timerStartPauseBtn.textContent = 'Start';
                            playAlarm();
                        }
                    }, 1000);
                }
            };

            const handlePresetChange = () => {
                const selectedId = timerPresetSelect.value;
                const selectedPreset = timerPresets.find(p => p.id === selectedId);
                if (!selectedPreset) return;
                const totalSeconds = selectedPreset.minutes * 60 + selectedPreset.seconds;
                timerState.totalDuration = totalSeconds;
                resetTimer();
            };

            const saveTimerPresets = () => {
                localStorage.setItem(TIMER_PRESETS_KEY, JSON.stringify(timerPresets));
            };

            const renderPresetDropdown = () => {
                const currentId = timerPresetSelect.value;
                timerPresetSelect.innerHTML = '';
                timerPresets.forEach(preset => {
                    const option = document.createElement('option');
                    option.value = preset.id;
                    option.textContent = formatTimeForDisplay(preset.minutes * 60 + preset.seconds);
                    timerPresetSelect.appendChild(option);
                });

                if (timerPresets.some(p => p.id === currentId)) {
                    timerPresetSelect.value = currentId;
                }
                handlePresetChange();
            };

            const loadTimerPresets = () => {
                const storedPresets = localStorage.getItem(TIMER_PRESETS_KEY);
                if (!storedPresets) {
                    timerPresets = [
                        { id: `preset_${Date.now()}_1`, minutes: 5, seconds: 0 },
                        { id: `preset_${Date.now()}_2`, minutes: 15, seconds: 0 },
                        { id: `preset_${Date.now()}_3`, minutes: 30, seconds: 0 },
                    ];
                    saveTimerPresets();
                } else {
                    timerPresets = JSON.parse(storedPresets);
                }
                renderPresetDropdown();
            };

            const openPresetManager = () => {
                renderPresetList();
                presetModalOverlay.classList.add('active');
            };
            const closePresetManager = () => {
                presetForm.reset();
                presetIdInput.value = '';
                presetModalOverlay.classList.remove('active');
            };

            const handlePresetDelete = (id) => {
                timerPresets = timerPresets.filter(p => p.id !== id);
                saveTimerPresets();
                renderPresetDropdown();
                renderPresetList();
            };

            const handlePresetEdit = (id) => {
                const preset = timerPresets.find(p => p.id === id);
                if (preset) {
                    presetIdInput.value = preset.id;
                    presetMinutesInput.value = preset.minutes;
                    presetSecondsInput.value = preset.seconds;
                }
            };

            const renderPresetList = () => {
                presetListContainer.innerHTML = '';
                if (timerPresets.length === 0) {
                    presetListContainer.innerHTML = `<p style="color: var(--text-color-secondary)">No presets yet. Add one below!</p>`;
                    return;
                }
                timerPresets.forEach(preset => {
                    const item = document.createElement('div');
                    item.className = 'preset-item';
                    item.innerHTML = `
                        <span>${formatTimeForDisplay(preset.minutes * 60 + preset.seconds)}</span>
                        <div class="preset-item-actions">
                            <button aria-label="Edit preset" data-action="edit" data-id="${preset.id}">‚úèÔ∏è</button>
                            <button aria-label="Delete preset" data-action="delete" data-id="${preset.id}">üóëÔ∏è</button>
                        </div>
                    `;
                    presetListContainer.appendChild(item);
                });
            };

            const handlePresetFormSubmit = (e) => {
                e.preventDefault();
                const id = presetIdInput.value;
                const minutes = parseInt(presetMinutesInput.value, 10);
                const seconds = parseInt(presetSecondsInput.value, 10);

                if (isNaN(minutes) || isNaN(seconds) || minutes < 0 || seconds < 0 || seconds > 59 || (minutes === 0 && seconds === 0)) {
                    showToast('Invalid preset time.');
                    return;
                }

                if (id) { // Editing existing
                    const index = timerPresets.findIndex(p => p.id === id);
                    if (index > -1) {
                        timerPresets[index] = { id, minutes, seconds };
                    }
                } else { // Adding new
                    const exists = timerPresets.some(p => p.minutes === minutes && p.seconds === seconds);
                    if (exists) {
                        showToast('This preset duration already exists.');
                        return;
                    }
                    timerPresets.push({ id: `preset_${Date.now()}`, minutes, seconds });
                }
                
                saveTimerPresets();
                renderPresetDropdown();
                renderPresetList();
                closePresetManager();
                showToast('Preset saved!');
            };

            // Tab switching logic
            const handleTabSwitch = (e) => {
                const targetTab = e.target.dataset.tab;
                if (!targetTab) return;
                tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === targetTab));
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${targetTab}-content`);
                });
            };

            const openTimerStopwatch = () => {
                timerStopwatchOverlay.classList.add('active');
                if (sideMenu.classList.contains('open')) toggleMenu();
            };
            const closeTimerStopwatch = () => timerStopwatchOverlay.classList.remove('active');

            // --- WEEKLY REMINDER ---
            const openReminderModal = () => reminderModalOverlay.classList.add('active');
            const closeReminderModal = () => reminderModalOverlay.classList.remove('active');
            const checkWeeklyReminder = () => {
                const today = new Date();
                const todayISO = today.toISOString().split('T')[0];
                const reminderKey = `meditation_reminder_shown_${todayISO}`;
                if (today.getDay() === 0 && !localStorage.getItem(reminderKey)) {
                    openReminderModal();
                    localStorage.setItem(reminderKey, 'true');
                }
            };

            // --- DELETE DATA ---
            const openDeleteModal = () => {
                deleteModalOverlay.classList.add('active');
                if (sideMenu.classList.contains('open')) toggleMenu();
            };
            const closeDeleteModal = () => deleteModalOverlay.classList.remove('active');
            const handleDeleteDataConfirmed = () => {
                data = [];
                saveDataToStorage();
                updateUIForDate(getTodayISO());
                closeDeleteModal();
                showToast('All data has been deleted.');
            };

            // --- INITIALIZATION ---
            const init = () => {
                // Main Listeners
                datePicker.addEventListener('change', handleDateChange);
                saveMorningBtn.addEventListener('click', () => handleSave('morning'));
                eveningInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleSave('evening'); });
                morningInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleSave('morning'); });
                saveEveningBtn.addEventListener('click', () => handleSave('evening'));
                document.querySelector('main').addEventListener('click', handleQuickSelect);
                
                // Menu Listeners
                menuToggleBtn.addEventListener('click', toggleMenu);
                menuOverlay.addEventListener('click', toggleMenu);
                historyBtn.addEventListener('click', openHistory);
                closeHistoryBtn.addEventListener('click', closeHistory);
                
                // Theme Listeners
                const themeInputs = [
                    { picker: themeColorPicker, input: themeColorInput },
                    { picker: bgColorPicker, input: bgColorInput },
                    { picker: cardBgColorPicker, input: cardBgColorInput },
                    { picker: textColorPicker, input: textColorInput }
                ];
                themeInputs.forEach(({ picker, input }) => {
                    picker.addEventListener('input', (e) => { input.value = e.target.value; });
                    input.addEventListener('change', (e) => { picker.value = e.target.value; });
                });
                applyThemeBtn.addEventListener('click', handleThemeApply);
                resetThemeBtn.addEventListener('click', handleThemeReset);
                globalSizeSlider.addEventListener('input', handleSizeChange);
                
                // Export/Import Listeners
                exportJsonBtn.addEventListener('click', handleExportJson);
                exportCsvBtn.addEventListener('click', handleExportCsv);
                downloadCsvHistoryBtn.addEventListener('click', handleExportCsv);
                importJsonBtn.addEventListener('click', () => importJsonInput.click());
                importJsonInput.addEventListener('change', handleImportJson);
                
                // CSV Modal Listeners
                csvConfirmExportBtn.addEventListener('click', handleConfirmExport);
                csvCancelExportBtn.addEventListener('click', closeCsvModal);

                // Reminder Modal Listeners
                reminderExportBtn.addEventListener('click', () => {
                    closeReminderModal();
                    handleExportCsv();
                });
                reminderLaterBtn.addEventListener('click', closeReminderModal);
                
                // New Timer & Stopwatch Listeners
                stopwatchBtn.addEventListener('click', openTimerStopwatch);
                closeTimerStopwatchBtn.addEventListener('click', closeTimerStopwatch);
                document.querySelector('.tab-nav').addEventListener('click', handleTabSwitch);
                timerStartPauseBtn.addEventListener('click', startPauseTimer);
                timerResetBtn.addEventListener('click', resetTimer);
                timerPresetSelect.addEventListener('change', handlePresetChange);
                managePresetsBtn.addEventListener('click', openPresetManager);
                presetForm.addEventListener('submit', handlePresetFormSubmit);
                presetCancelBtn.addEventListener('click', closePresetManager);
                presetListContainer.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    const { action, id } = button.dataset;
                    if (action === 'edit') {
                        handlePresetEdit(id);
                    } else if (action === 'delete') {
                        if (confirm('Are you sure you want to delete this preset?')) {
                            handlePresetDelete(id);
                        }
                    }
                });

                // Stopwatch Listeners
                stopwatchStartBtn.addEventListener('click', startStopwatch);
                stopwatchPauseBtn.addEventListener('click', pauseStopwatch);
                stopwatchResetBtn.addEventListener('click', resetStopwatch);
                stopwatchAddMorningBtn.addEventListener('click', () => addStopwatchToSession('morning'));
                stopwatchAddEveningBtn.addEventListener('click', () => addStopwatchToSession('evening'));

                // Delete Data Listeners
                deleteDataBtn.addEventListener('click', openDeleteModal);
                deleteCancelBtn.addEventListener('click', closeDeleteModal);
                deleteConfirmBtn.addEventListener('click', handleDeleteDataConfirmed);

                // Proactive Audio Unlock: Attach a one-time listener to the whole document
                // to unlock the audio context on the user's first interaction.
                document.body.addEventListener('click', unlockAudioContext, { once: true });
                document.body.addEventListener('touchend', unlockAudioContext, { once: true });

                // Load initial state
                loadDataFromStorage();
                backfillMissingDays();
                loadTheme();
                loadGlobalSize();
                loadTimerPresets();
                datePicker.value = getTodayISO();
                updateHeaderDate();
                updateUIForDate(datePicker.value);
                checkWeeklyReminder();

                // Register Service Worker for PWA
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/service-worker.js')
                            .then(registration => {
                                console.log('ServiceWorker registration successful with scope: ', registration.scope);
                            })
                            .catch(err => {
                                console.log('ServiceWorker registration failed: ', err);
                            });
                    });
                }
            };

            init();
        });
    </script>
</body>
</html>
